---
import PagefindSearch from './pagefind-search.astro'
---

<button
  id="searchToggle"
  aria-label="searchToggle"
  class="hover:bg-primary-gray/20 dark:hover:bg-primary-gray/30 cursor-pointer rounded-md p-2 transition-colors"
>
  <svg width="20px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path
      fill-rule="evenodd"
      d="M10.5 3.75a6.75 6.75 0 1 0 0 13.5 6.75 6.75 0 0 0 0-13.5ZM2.25 10.5a8.25 8.25 0 1 1 14.59 5.28l4.69 4.69a.75.75 0 1 1-1.06 1.06l-4.69-4.69A8.25 8.25 0 0 1 2.25 10.5Z"
    ></path>
  </svg>
</button>

<!-- 搜索弹窗 -->
<div id="searchModal" class="search-modal fixed inset-0 z-[1000] box-border hidden items-center justify-center p-4">
  <div class="search-modal-overlay absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
  <div
    class="search-modal-content bg-primary-light dark:bg-primary-dark relative m-auto flex h-[80vh] max-h-[600px] w-full max-w-3xl flex-col overflow-hidden rounded-xl shadow-2xl"
  >
    <div
      class="search-modal-header border-primary-gray bg-primary-light dark:bg-primary-dark flex shrink-0 items-center justify-between border-b px-6 py-4"
    >
      <h2 class="text-primary-dark dark:text-primary-light m-0 text-xl font-semibold">搜索</h2>
      <button
        id="searchClose"
        aria-label="关闭搜索"
        class="search-close-btn hover:bg-primary-gray/20 dark:hover:bg-primary-gray/30 rounded-md p-2 transition-colors"
      >
        <svg width="20px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
          <path
            fill-rule="evenodd"
            d="M5.47 5.47a.75.75 0 0 1 1.06 0L12 10.94l5.47-5.47a.75.75 0 1 1 1.06 1.06L13.06 12l5.47 5.47a.75.75 0 1 1-1.06 1.06L12 13.06l-5.47 5.47a.75.75 0 0 1-1.06-1.06L10.94 12 5.47 6.53a.75.75 0 0 1 0-1.06Z"
          ></path>
        </svg>
      </button>
    </div>
    <div class="search-modal-body flex flex-1 flex-col overflow-hidden p-6">
      <PagefindSearch />
    </div>
  </div>
</div>

<script>
  document.addEventListener('astro:page-load', () => {
    bindModalEvents()
  })

  function bindModalEvents() {
    const searchToggle = document.getElementById('searchToggle')
    const searchModal = document.getElementById('searchModal')
    const searchClose = document.getElementById('searchClose')
    const searchModalOverlay = document.querySelector('.search-modal-overlay')

    // 打开搜索弹窗
    searchToggle?.addEventListener('click', () => {
      searchModal?.classList.remove('hidden')
      searchModal?.classList.add('flex')
      document.body.style.overflow = 'hidden'

      // 聚焦到搜索输入框
      setTimeout(() => {
        const searchInput = document.querySelector('.pagefind-ui__search-input') as HTMLInputElement
        searchInput?.focus()
      }, 100)
    })

    // 关闭搜索弹窗
    const closeModal = () => {
      searchModal?.classList.add('hidden')
      searchModal?.classList.remove('flex')
      document.body.style.overflow = ''
    }

    searchClose?.addEventListener('click', closeModal)
    searchModalOverlay?.addEventListener('click', (e) => {
      if (e.target === searchModalOverlay) {
        closeModal()
      }
    })

    // ESC 键关闭弹窗
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && !searchModal?.classList.contains('hidden')) {
        closeModal()
      }
    })
  }
</script>
